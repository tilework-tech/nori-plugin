/**
 * Skillset management for Nori Skillsets
 * Handles skillset listing, loading, and switching
 */

import { captureExistingConfigAsProfile } from "@/cli/commands/install/existingConfigCapture.js";
import {
  loadConfig,
  getAgentProfile,
  getInstalledAgents,
  type ConfigAgentName,
} from "@/cli/config.js";
import { AgentRegistry } from "@/cli/features/agentRegistry.js";
import { getClaudeDir } from "@/cli/features/claude-code/paths.js";
import {
  readManifest,
  compareManifest,
  hasChanges,
  getManifestPath,
  type ManifestDiff,
} from "@/cli/features/claude-code/profiles/manifest.js";
import { listProfiles } from "@/cli/features/managedFolder.js";
import { error, setSilentMode, isSilentMode } from "@/cli/logger.js";
import { switchSkillsetFlow } from "@/cli/prompts/flows/switchSkillset.js";
import { normalizeInstallDir, getInstallDirs } from "@/utils/path.js";

import type { Command } from "commander";

/**
 * Detect local changes to installed files
 *
 * Compares the current state of ~/.claude/ against the stored manifest
 * to detect any user modifications.
 *
 * @param args - Configuration arguments
 * @param args.installDir - Installation directory
 *
 * @returns Manifest diff if changes detected, null otherwise
 */
const detectLocalChanges = async (args: {
  installDir: string;
}): Promise<ManifestDiff | null> => {
  const { installDir } = args;

  const manifestPath = getManifestPath();
  const manifest = await readManifest({ manifestPath });

  // No manifest means first install or manual setup - no changes detectable
  if (manifest == null) {
    return null;
  }

  const claudeDir = getClaudeDir({ installDir });
  const diff = await compareManifest({ manifest, currentDir: claudeDir });

  return hasChanges(diff) ? diff : null;
};

/**
 * Shared action handler for switch-skillset and switch-profile commands
 * @param args - Configuration arguments
 * @param args.name - The skillset name to switch to
 * @param args.options - Command options
 * @param args.options.agent - Optional agent name override
 * @param args.program - Commander program instance
 * @param args.options.force - Whether to force through local changes without prompting
 */
export const switchSkillsetAction = async (args: {
  name: string;
  options: { agent?: string; force?: boolean };
  program: Command;
}): Promise<void> => {
  const { name, options, program } = args;

  // Get global options from parent
  const globalOpts = program.opts();
  const nonInteractive = globalOpts.nonInteractive ?? false;
  const force = options.force ?? false;

  // Determine installation directory
  let installDir: string;

  if (globalOpts.installDir != null && globalOpts.installDir !== "") {
    // Explicit install dir provided - use it directly
    installDir = normalizeInstallDir({ installDir: globalOpts.installDir });
  } else {
    // Auto-detect installation
    const installations = getInstallDirs({ currentDir: process.cwd() });
    if (installations.length === 0) {
      throw new Error(
        "No Nori installations found in current directory or parent directories. " +
          "Run 'nori-skillsets init' to create a new installation, or use --install-dir to specify a location.",
      );
    }
    installDir = installations[0]; // Use closest installation
  }

  // Interactive flow
  if (!nonInteractive) {
    await switchSkillsetFlow({
      profileName: name,
      installDir,
      agentOverride: options.agent ?? null,
      callbacks: {
        onResolveAgents: async () => {
          const config = await loadConfig();
          const installedAgents = config ? getInstalledAgents({ config }) : [];
          if (installedAgents.length === 0) {
            return [{ name: "claude-code", displayName: "Claude Code" }];
          }
          return installedAgents.map((agentName) => {
            const agent = AgentRegistry.getInstance().get({
              name: agentName,
            });
            return { name: agentName, displayName: agent.displayName };
          });
        },
        onPrepareSwitchInfo: async ({ installDir: dir, agentName }) => {
          const localChanges = await detectLocalChanges({ installDir: dir });
          const config = await loadConfig();
          let currentProfile: string | null = null;
          if (config != null) {
            const agentProfile = getAgentProfile({
              config,
              agentName: agentName as ConfigAgentName,
            });
            currentProfile = agentProfile?.baseProfile ?? null;
          }
          return { currentProfile, localChanges };
        },
        onCaptureConfig: async ({ installDir: dir, profileName: pName }) => {
          await captureExistingConfigAsProfile({
            installDir: dir,
            profileName: pName,
          });
        },
        onExecuteSwitch: async ({
          installDir: dir,
          agentName,
          profileName: pName,
        }) => {
          const agent = AgentRegistry.getInstance().get({ name: agentName });
          const wasSilent = isSilentMode();
          setSilentMode({ silent: true });
          try {
            await agent.switchProfile({ installDir: dir, profileName: pName });
          } catch (err) {
            setSilentMode({ silent: wasSilent });
            const profiles = await listProfiles();
            if (profiles.length > 0) {
              error({
                message: `Available skillsets: ${profiles.join(", ")}`,
              });
            }
            throw err;
          }
          setSilentMode({ silent: wasSilent });
          const { main: installMain } =
            await import("@/cli/commands/install/install.js");
          await installMain({
            nonInteractive: true,
            installDir: dir,
            agent: agentName,
            silent: true,
          });
        },
      },
    });

    // Flow handles all UI (cancel messages, success notes) internally.
    // result is null on cancel, non-null on success â€” either way we're done.
    return;
  }

  // Non-interactive flow
  const agentName = options.agent ?? "claude-code";
  const agent = AgentRegistry.getInstance().get({ name: agentName });

  // Check for local changes before proceeding
  const localChanges = await detectLocalChanges({ installDir });

  if (localChanges != null && !force) {
    throw new Error(
      `Local changes detected in installed skillset files. ` +
        `Cannot proceed in non-interactive mode. ` +
        `Modified: ${localChanges.modified.length}, Added: ${localChanges.added.length}, Deleted: ${localChanges.deleted.length}. ` +
        `Run interactively to choose how to handle these changes, or use --force to discard them.`,
    );
  }

  try {
    // Delegate to agent's switchProfile method
    await agent.switchProfile({ installDir, profileName: name });
  } catch (err) {
    // On failure, show available skillsets
    const profiles = await listProfiles();
    if (profiles.length > 0) {
      error({ message: `Available skillsets: ${profiles.join(", ")}` });
    }
    throw err;
  }

  // Run install in silent mode to regenerate files with new skillset
  const { main: installMain } =
    await import("@/cli/commands/install/install.js");
  await installMain({
    nonInteractive: true,
    installDir,
    agent: agentName,
    silent: true,
  });
};

/**
 * Register the 'switch' and 'switch-profile' (alias) commands with commander
 * @param args - Configuration arguments
 * @param args.program - Commander program instance
 */
export const registerSwitchProfileCommand = (args: {
  program: Command;
}): void => {
  const { program } = args;

  // Primary command: switch-skillset
  program
    .command("switch-skillset <name>")
    .description("Switch to a different skillset and reinstall")
    .option("-a, --agent <name>", "AI agent to switch skillset for")
    .option("--force", "Force switch even when local changes are detected")
    .action(
      async (name: string, options: { agent?: string; force?: boolean }) => {
        await switchSkillsetAction({ name, options, program });
      },
    );

  // Alias command: switch-profile (for backward compatibility)
  program
    .command("switch-profile <name>")
    .description(
      "Alias for switch-skillset - Switch to a different skillset and reinstall",
    )
    .option("-a, --agent <name>", "AI agent to switch skillset for")
    .option("--force", "Force switch even when local changes are detected")
    .action(
      async (name: string, options: { agent?: string; force?: boolean }) => {
        await switchSkillsetAction({ name, options, program });
      },
    );
};
